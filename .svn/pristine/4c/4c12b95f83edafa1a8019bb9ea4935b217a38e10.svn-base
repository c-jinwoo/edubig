<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 클래스데스크 > 게시판관련 -->
<mapper namespace="com.webapp.classdesk.mapper.ClassdeskBoardMapper">
	<resultMap id="clobMap" type="emap">      
        <result property="CONTENT" column="CONTENT" jdbcType="CLOB" javaType="java.lang.String"/>
        <result property="AN_CONTENT" column="AN_CONTENT" jdbcType="CLOB" javaType="java.lang.String"/>
    </resultMap>  
    
	<select id="getBoardList" parameterType="dmap" resultType="emap">
	  SELECT * FROM 
			(SELECT a.*, ROWNUM AS RNUM FROM
				(  
					SELECT 
						  BBSNO, WRITER, TO_CHAR(WDATE,'yyyy-mm-dd') AS WDATE, TITLE, RCNT, Z.BCATENO, Z.BCATENAME, ANYN, Y.POPYN, Y.POP_PATH, Y.POP_FILE,
						  '-' AS USERID, '-' AS SAVPATH, '-' AS SAVFILE, '-' AS ORGFILE, Z.BBSTYPE, Z.INTYPE, GRPNO, REFLEVEL, REFSTEP,
						  CASE WHEN (SYSDATE - WDATE <![CDATA[ <= ]]> 1 AND SYSDATE - WDATE <![CDATA[ > ]]> 0) THEN 'new_btn' ELSE 'null_btn'  END AS NEWBTN,
						    COUNT(BBSNO) OVER() TOTAL,  COURSENO, CSEQNO
					FROM
					(
					  SELECT * FROM (
						SELECT X.*  FROM (
							SELECT 
								BBSNO BNO FROM LMS_ED_BBS
							WHERE 1=1 
								<choose>
			                        <when test="bcateno != null and bcateno != ''">
			                            AND BCATENO = #{bcateno}
			                        </when>
			                        <otherwise>
			                            AND BCATENO IN (
			                                    SELECT BCATENO 
			                                      FROM LMS_ED_BBS_CATEGORY 
			                                     WHERE PBCATENO = #{bcateno}
			                               )  
			                        </otherwise>
			                    </choose>
							AND 
								COURSENO =  #{SES_COURSENO}
							AND 
								CSEQNO =  #{SES_CSEQNO}
							<if test="searchWord != null and searchWord != ''">
		                        <if test="searchMode == 'title'">
		                            AND TITLE LIKE '%'|| #{searchWord} ||'%'
	                        	</if>	
								<if test="searchMode == 'content'">
		                            AND CONTENT LIKE '%'|| #{searchWord} ||'%'
		                        </if>
		                        <if test="searchMode == 'writer'">
		                            AND WRITER LIKE '%'|| #{searchWord} ||'%'
		                        </if>
		                    </if>
							ORDER BY GRPNO DESC, BBSNO ASC) X
						 )   
					) X, LMS_ED_BBS Y, LMS_ED_BBS_CATEGORY Z
					WHERE X.BNO = Y.BBSNO AND Y.BCATENO = Z.BCATENO 
					ORDER BY  BBSNO DESC
				) a WHERE 1=1 
			)  
		<if test="startNo != null and startNo != ''">
            WHERE RNUM BETWEEN #{startNo} AND #{endNo}
        </if>
	</select>
	
	<insert id="insertBoardInfo" parameterType="dmap">
		INSERT 
		  INTO LMS_ED_BBS 
		       ( 
		           BBSNO, 
		           WRITER, 
		           WDATE, 
		           TITLE, 
		           CONTENT, 
		           RCNT, 
		           GRPNO, 
		           REFLEVEL, 
		           REFSTEP, 
		           USERNO, 
		           BCATENO, 
		           PWD, 
		           ETC_INFO01,
		           TOPYN,
		           POPYN,
		           POP_PATH,
		           POP_FILE,
		           POP_WIDTH,
		           POP_HEIGHT,
		           COURSENO,
		           CSEQNO,
		           OPEN_AT
		       ) 
		       VALUES 
		       (
		              #{bbsNo}, 
		              #{SES_USERNAME}, 
		              SYSDATE, 
		              #{title}, 
		              #{summary}, 
		              0, 
		              #{bbsNo}, 
		              0, 
		              0, 
		              #{SES_USERNO}, 
		              <choose>
			              <when test="bcateno != null and bcateno != ''">
			                  #{bcateno},
			              </when>
			              <otherwise>
			                  (
			                      SELECT MIN(BCATENO) 
			                        FROM LMS_ED_BBS_CATEGORY 
			                       WHERE PBCATENO = #{pbcateno}
			                  ), 
			              </otherwise>
			          </choose>
		              '', 
		              '',
		              #{topYn},
		              #{popYn},
		              #{popPath},
		              #{popFile},
		              #{popWidth},
		              #{popHeight},
		              #{SES_COURSENO},
		              #{SES_CSEQNO},
		              #{openAt}
		          )
	</insert>
	
	<!-- 파일 bbsno 등록 -->
    <update id="updateFileBbsno" parameterType="dmap">
    	UPDATE LMS_ED_BBS_FILE
		   SET BBSNO = #{bbsNo}
		 WHERE FILE_ID = #{fileId}
    </update>
	
	
	<select id="getMaxBoardNo" resultType="int" >
		SELECT NVL(MAX(BBSNO),0)+1 
		  FROM LMS_ED_BBS
	</select>
	
	<select id="getBoardView" resultMap="clobMap" parameterType="dmap">
		SELECT 
			TITLE ,
			TO_CHAR(WDATE,'yyyy-mm-dd') AS WDATE ,
			RCNT ,
			BBSNO,
			CONTENT
		FROM LMS_ED_BBS WHERE COURSENO = #{SES_COURSENO} AND CSEQNO = #{SES_CSEQNO} AND BCATENO = #{bcateno} 
		AND BBSNO = #{bbsNo}
		ORDER BY WDATE ASC
	</select>
	
	<update id="updateBoardViewCnt" parameterType="dmap">
		UPDATE LMS_ED_BBS 
	       SET RCNT = RCNT+1 
	 WHERE BBSNO = #{bbsNo}
	</update>
	
		
	<update id="updateBoardInfo" parameterType="dmap">
		UPDATE LMS_ED_BBS 
		       SET TITLE = #{title}, 
		       CONTENT = #{summary},
			   WDATE = sysdate 
		 WHERE BBSNO = #{bbsNo} 
	</update>
	
		
	<delete id="deleteBoardInfo" parameterType="dmap">
		DELETE FROM LMS_ED_BBS 
		 WHERE BBSNO = #{bbsNo} 
	</delete>
	
	<select id="getFileInfo" resultType="emap" parameterType="int">
		SELECT FILE_ID,
		       ORGFILE,
		       SAVFILE,
		       SAVPATH 
		  FROM LMS_ED_BBS_FILE 
		 WHERE FILE_ID = #{fileNo}
	</select>
	
	<select id="getBbsFileInfo" resultType="emap" parameterType="dmap">
		SELECT FILE_ID,
		       ORGFILE,
		       SAVFILE,
		       SAVPATH,
		       FILE_SIZE,
		       BBSNO
		  FROM LMS_ED_COURSE_FILE 
		 WHERE BBSNO = #{bbsNo}
		 AND FILE_ID = #{fileId}
		 AND FILE_SEQ = #{fileSeq}
	</select>
	
	<!-- 파일 삭제 -->
    <delete id="deleteFileInfo" parameterType="dmap">
        DELETE
          FROM LMS_ED_BBS_FILE
         WHERE BBSNO = #{bbsNo}
    </delete>
	
	<insert id="insertFileInfo" parameterType="dmap">
		INSERT INTO LMS_ED_BBS_FILE 
	       (
	           FILE_ID,
	           ORGFILE,
	           SAVFILE,
	           FILE_SIZE,
	           FTYPE,
	           DCNT,
	           BBSNO,
	           SAVPATH
	       ) 
	    VALUES
	       (
	              (SELECT NVL(MAX(FILE_ID),1)+1 
	                FROM LMS_ED_BBS_FILE
	              ),
	              #{uploadFileOrgName},
	              #{uploadFileSaveName},
	              #{uploadFileSize},
	              '.',
	              0,
	              #{bbsNo},
	              #{uploadFileFulltPath}
	    ) 
	</insert>
	
	<select id="getFileList" resultType="emap" parameterType="dmap">
		SELECT FILE_ID,
			   FILE_SEQ,
		       ORGFILE,
		       SAVFILE,
		       SAVPATH,
		       FILE_SIZE,
		       BBSNO
		  FROM LMS_ED_COURSE_FILE 
		 WHERE BBSNO = #{bbsNo}
	</select>

	<!-- 과정별 게시판 리스트 -->
	<select id="getCourseBbsList" resultType="emap" parameterType="dmap">
		SELECT 
			TITLE ,
			TO_CHAR(WDATE,'yyyy-mm-dd') AS WDATE ,
			RCNT ,
			BBSNO
		FROM LMS_ED_BBS WHERE COURSENO = #{SES_COURSENO} AND CSEQNO = #{SES_CSEQNO} AND BCATENO = #{bcateno} 
		ORDER BY WDATE ASC
	</select>
	 
	 <select id="getCourseBbsListCount" resultType="int" parameterType="dmap">
		SELECT COUNT(*) FROM 
            (SELECT a.* FROM
                (  
					SELECT 
 					  CASE WHEN (CSEQNO = #{SES_CSEQNO})    THEN 'N' ELSE 'Y' END AS COMYN,  BBSNO, COURSENO, CSEQNO, WRITER, TO_CHAR(WDATE,'yyyy-mm-dd') AS WDATE, TITLE, RCNT, Z.BCATENO, Z.BCATENAME, ANYN, Y.POPYN, Y.POP_PATH, Y.POP_FILE,
					  '-' AS USERID, '-' AS SAVPATH, '-' AS SAVFILE, '-' AS ORGFILE, Z.BBSTYPE, Z.INTYPE, GRPNO, REFLEVEL, REFSTEP,
					  CASE WHEN (SYSDATE - WDATE <![CDATA[ <= ]]> 1 AND SYSDATE - WDATE <![CDATA[ > ]]> 0) THEN 'new_btn' ELSE 'null_btn'  END AS NEWBTN,
                      ROWNUM AS RNUM, OPEN_AT
                      <!-- COUNT(BBSNO) OVER() TOTAL  -->
					FROM
					(
					  SELECT * FROM (
					    SELECT X.* FROM (
					      SELECT BBSNO BNO
                            FROM LMS_ED_BBS
                           WHERE 1=1
					        <choose>
		                        <when test="bcateno != null and bcateno != ''">
		                            AND BCATENO = #{bcateno}
		                        </when>
		                        <otherwise>
		                            AND BCATENO IN (
		                                    SELECT BCATENO 
		                                      FROM LMS_ED_BBS_CATEGORY 
		                                     WHERE PBCATENO = #{pbcateno}
		                               )  
		                        </otherwise>
		                    </choose>  
					   		
					      ORDER BY GRPNO DESC, BBSNO ASC) X
					  )X
					) X, LMS_ED_BBS Y, LMS_ED_BBS_CATEGORY Z
					WHERE X.BNO = Y.BBSNO 
					AND Z.BCATENO = CASE WHEN LENGTH(Y.BCATENO) > 1 
                                                      THEN SUBSTR(Y.BCATENO,3,1) 
                                                       ELSE SUBSTR(Y.BCATENO,1)                 
                                                        END 
					AND Y.COURSENO = #{SES_COURSENO}
					AND (Y.CSEQNO = #{SES_CSEQNO} OR Y.CSEQNO= 0 ) 
					ORDER BY GRPNO DESC, BBSNO ASC
		   ) a WHERE 1=1
		   	   AND A.OPEN_AT = 'Y'
			)a WHERE 1=1
			<if test="searchWord != null and searchWord != '' ">
		   		AND TITLE LIKE '%' || #{searchWord} || '%'
		   	</if>
	</select>
	
</mapper>